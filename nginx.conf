##########
# Global #
##########
user abc;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules/*.conf;
daemon off;

events {
  worker_connections 1024;
}

###############
# HTTP/Server #
###############
http {
  ###########
  # General #
  ###########
  client_body_buffer_size 128k;
  client_max_body_size 100M;
  keepalive_timeout 65;
  large_client_header_buffers 4 16k;
  send_timeout 5m;
  sendfile on;
  sendfile_max_chunk 100M;
  tcp_nodelay on;
  tcp_nopush on;
  types_hash_max_size 2048;
  variables_hash_max_size 2048;

  include /etc/nginx/mime.types;
  default_type application/octet-stream;


  ###########
  # Logging #
  ###########
  access_log /config/log/nginx/access.log;
  error_log /config/log/nginx/error.log;


  ########
  # Gzip #
  ########
  gzip on;
  gzip_disable "msie6";
  # gzip_vary on;
  # gzip_proxied any;
  # gzip_comp_level 6;
  # gzip_buffers 16 8k;
  # gzip_http_version 1.1;
  # gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;


  ##############
  # WebSockets #
  ##############
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }


  ##############
  # Cloudflare #
  ##############
  ###
  # Configure bypass of Authenticated Origin Pulls for LAN
  # More relevant config at the end of ssl.conf
  ###
  geo $intranet {
    default 0;
    172.16.0.0/12 1;
    192.168.0.0/16 1;
  }
  ###
  # Get Real-IP since we're behind Cloudflare â€” needed for fail2ban
  ###
  set_real_ip_from 173.245.48.0/20;
  set_real_ip_from 103.21.244.0/22;
  set_real_ip_from 103.22.200.0/22;
  set_real_ip_from 103.31.4.0/22;
  set_real_ip_from 141.101.64.0/18;
  set_real_ip_from 108.162.192.0/18;
  set_real_ip_from 190.93.240.0/20;
  set_real_ip_from 188.114.96.0/20;
  set_real_ip_from 197.234.240.0/22;
  set_real_ip_from 198.41.128.0/17;
  set_real_ip_from 162.158.0.0/15;
  set_real_ip_from 172.64.0.0/13;
  set_real_ip_from 131.0.72.0/22;
  set_real_ip_from 104.16.0.0/13;
  set_real_ip_from 104.24.0.0/14;
  set_real_ip_from 2400:cb00::/32;
  set_real_ip_from 2606:4700::/32;
  set_real_ip_from 2803:f800::/32;
  set_real_ip_from 2405:b500::/32;
  set_real_ip_from 2405:8100::/32;
  set_real_ip_from 2a06:98c0::/29;
  set_real_ip_from 2c0f:f248::/32;
  real_ip_recursive on;
  real_ip_header CF-Connecting-IP; # Could also be X-Forwarded-For, but this is ALWAYS sent by Cloudflare


  ###########
  # Servers #
  ###########
  error_page 502 /502.html; # use http.cat Laterâ„¢

  ##############
  # xnaas.info #
  ##############
  # https://xnaas.info
  server {
    listen 443 ssl default_server;
    server_name xnaas.info;
    include /config/nginx/ssl.conf;

    root /www/websites/xnaas.info;
    index index.html;

    location / {
      try_files $uri $uri/ /index.html =404;
    }

    location /tmp/ {
      alias /www/tmp/;
      try_files $uri $uri/ =404;
    }

    location /pgp {
      return 302 https://github.com/xnaas/pgp;
    }
  }


  # https://home.xnaas.info
  server {
    listen 443 ssl;
    server_name home.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app 192.168.1.150;
      set $upstream_port 5000;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://irc.xnaas.info
  server {
    listen 443 ssl;
    server_name irc.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app thelounge;
      set $upstream_port 9000;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://kb.xnaas.info
  server {
    listen 443 ssl;
    server_name kb.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app wikijs;
      set $upstream_port 3000;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://music.xnaas.info
  server {
    listen 443 ssl;
    server_name music.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app music;
      set $upstream_port 4533;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://ombi.xnaas.info
  server {
    listen 443 ssl;
    server_name ombi.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app ombi;
      set $upstream_port 3579;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # This allows access to the actual api
    location ~ (/ombi)?/api {
      include /config/nginx/proxy.conf;
      set $upstream_app ombi;
      set $upstream_port 3579;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    # This allows access to the documentation for the api
    location ~ (/ombi)?/swagger {
      include /config/nginx/proxy.conf;
      set $upstream_app ombi;
      set $upstream_port 3579;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    if ($http_referer ~* /ombi) {
      rewrite ^/swagger/(.*) /ombi/swagger/$1? redirect;
    }
  }


  # https://p.xnaas.info
  server {
    listen 443 ssl;
    server_name p.xnaas.info;
    include /config/nginx/ssl.conf;

    root /www/websites/p.xnaas.info;

    location / {
      try_files $uri $uri/ /index.html =404;
      fancyindex on;
      fancyindex_exact_size off;
      fancyindex_localtime on;
      fancyindex_header "/nginx-dark/header.html";
      fancyindex_footer "/nginx-dark/footer.html";
      fancyindex_ignore "nginx-dark";
    }
  }


  # https://plex.xnaas.info
  server {
    listen 443 ssl;
    server_name plex.xnaas.info;
    include /config/nginx/ssl.conf;
    
    proxy_redirect off;
    proxy_buffering off;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app 192.168.1.101;
      set $upstream_port 32400;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
      
      # Are these even needed? â€” Testing required.
      proxy_set_header X-Plex-Client-Identifier $http_x_plex_client_identifier;
      proxy_set_header X-Plex-Device $http_x_plex_device;
      proxy_set_header X-Plex-Device-Name $http_x_plex_device_name;
      proxy_set_header X-Plex-Platform $http_x_plex_platform;
      proxy_set_header X-Plex-Platform-Version $http_x_plex_platform_version;
      proxy_set_header X-Plex-Product $http_x_plex_product;
      proxy_set_header X-Plex-Token $http_x_plex_token;
      proxy_set_header X-Plex-Version $http_x_plex_version;
      proxy_set_header X-Plex-Nocache $http_x_plex_nocache;
      proxy_set_header X-Plex-Provides $http_x_plex_provides;
      proxy_set_header X-Plex-Device-Vendor $http_x_plex_device_vendor;
      proxy_set_header X-Plex-Model $http_x_plex_model;
    }
  }


  # https://plexpy.xnaas.info
  server {
    listen 443 ssl;
    server_name plexpy.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app plexpy;
      set $upstream_port 8181;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    location ~ (/tautulli)?/api {
      include /config/nginx/proxy.conf;
      set $upstream_app plexpy;
      set $upstream_port 8181;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    location ~ (/tautulli)?/image {
      include /config/nginx/proxy.conf;
      set $upstream_app plexpy;
      set $upstream_port 8181;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://rss.xnaas.info
  server {
    listen 443 ssl;
    server_name rss.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app rss;
      set $upstream_port 80;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;

      proxy_redirect off;
      proxy_buffering off;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_cookie_path / "/; HTTPOnly; Secure";
      proxy_set_header Authorization $http_authorization;
      proxy_pass_header Authorization;
    }
  }


  # https://tesla.xnaas.info
  server {
    listen 443 ssl;
    server_name tesla.xnaas.info;
    include /config/nginx/ssl.conf;

    auth_basic "Restricted";
    auth_basic_user_file /config/nginx/.xadmin;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app teslamate;
      set $upstream_port 4000;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://teslag.xnaas.info
  server {
    listen 443 ssl;
    server_name teslag.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app teslamate-grafana;
      set $upstream_port 3000;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://www.*
  server {
    listen 443 ssl;
    server_name www.*;
    include /config/nginx/ssl.conf;
    return 302 https://dropwww.com/why;
  }


  # https://ãƒ„.xnaas.info
  server {
    listen 443 ssl;
    server_name xn--bdk.xnaas.info;
    include /config/nginx/ssl.conf;

    root /www/websites/ãƒ„.xnaas.info;
    index index.html;

    location / {
      try_files $uri $uri/ /index.html =404;
    }
  }


  # https://ðŸ¤ª.xnaas.info
  server {
    listen 443 ssl;
    server_name xn--jq9h.xnaas.info;
    include /config/nginx/ssl.conf;

    root /www/websites/ðŸ¤ª.xnaas.info;
    index index.html;

    location / {
      try_files $uri $uri/ /index.html =404;
    }
  }


  # https://ðŸ¤«.xnaas.info
  server {
    listen 443 ssl;
    server_name xn--kq9h.xnaas.info;
    include /config/nginx/ssl.conf;

    root /www/websites/ðŸ¤«.xnaas.info;
    index index.html;

    location / {
      try_files $uri $uri/ /index.html =404;
      fancyindex on;
      fancyindex_exact_size off;
      fancyindex_localtime on;
      fancyindex_header "/nginx-dark/header.html";
      fancyindex_footer "/nginx-dark/footer.html";
      fancyindex_ignore "nginx-dark";
    }
  }


  ##################
  # actionsack.com #
  ##################
  # https://actionsack.com
  server {
    listen 443 ssl;
    server_name actionsack.com;
    include /config/nginx/ssl.conf;

    root /www/websites/actionsack.com;
    index index.html;

    location / {
      try_files $uri $uri/ /index.html =404;
    }

    location /img/ {
      try_files $uri $uri/ =404;
      fancyindex on;
      fancyindex_exact_size off;
      fancyindex_localtime on;
      fancyindex_header "/nginx-dark/header.html";
      fancyindex_footer "/nginx-dark/footer.html";
      fancyindex_ignore "nginx-dark";
      fancyindex_ignore "nig";
    }

    location /tmp/ {
      alias /www/tmp/;
      try_files $uri $uri/ =404;
    }
  }


  # https://bib.actionsack.com
  server {
    listen 443 ssl;
    server_name bib.actionsack.com;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app bibliogram;
      set $upstream_port 10407;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://chat.actionsack.com
  server {
    listen 443 ssl;
    server_name _.actionsack.com;
    include /config/nginx/ssl.conf;
    
    root /www/websites/actionsack.com;
    index index.html;

    location / {
      try_files $uri $uri/ /index.html =404;
    }
  }


  # https://dl.actionsack.com
  server {
    listen 443 ssl;
    server_name dl.actionsack.com;
    include /config/nginx/ssl.conf;

    root /www/download;

    auth_basic "Restricted";
    auth_basic_user_file /config/nginx/.asak;

    location / {
      try_files $uri $uri/ /index.html =404;
      fancyindex on;
      fancyindex_exact_size off;
      fancyindex_localtime on;
      fancyindex_header "/nginx-dark/header.html";
      fancyindex_footer "/nginx-dark/footer.html";
      fancyindex_ignore "nginx-dark";
    }
  }


  # https://nitter.actionsack.com
  server {
    listen 443 ssl;
    server_name nitter.actionsack.com;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app nitter;
      set $upstream_port 8080;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://rss.actionsack.com
  server {
    listen 443 ssl;
    server_name rss.actionsack.com;
    include /config/nginx/ssl.conf;
    
    auth_basic "Restricted";
    auth_basic_user_file /config/nginx/.asak;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app rss-bridge;
      set $upstream_port 80;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://ytdl.actionsack.com
  server {
    listen 443 ssl;
    server_name ytdl.actionsack.com;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app youtubedl;
      set $upstream_port 8080;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }
}
