##########
# Global #
##########
user abc;
worker_processes auto;
worker_rlimit_nofile 8192;
pcre_jit on;
pid /run/nginx.pid;
error_log /config/log/nginx/error.log;
include /etc/nginx/modules/*.conf;
daemon off;
events {
  worker_connections 8000;
}

###############
# HTTP/Server #
###############
http {
  ###########
  # General #
  ###########
  client_body_buffer_size 128k;
  client_max_body_size 100M;
  keepalive_timeout 90s;
  large_client_header_buffers 4 16k;
  send_timeout 5m;
  sendfile on;
  sendfile_max_chunk 100M;
  tcp_nodelay on;
  tcp_nopush on;
  types_hash_max_size 2048;
  variables_hash_max_size 2048;
  server_tokens off;
  resolver 127.0.0.11 valid=30s;

  include /etc/nginx/mime.types;
  default_type application/octet-stream;


  ###########
  # Logging #
  ###########
  access_log /config/log/nginx/access.log;


  ########
  # Gzip #
  ########
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_vary on;
  gzip_types application/atom+xml application/geo+json application/javascript application/x-javascript application/json application/ld+json application/manifest+json application/rdf+xml application/rss+xml application/vnd.ms-fontobject application/wasm application/x-web-app-manifest+json application/xhtml+xml application/xml font/eot font/otf font/ttf image/bmp image/svg+xml image/vnd.microsoft.icon image/x-icon text/cache-manifest text/calendar text/css text/javascript text/markdown text/plain text/xml text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;


  ##############
  # WebSockets #
  ##############
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }


  ##############
  # Cloudflare #
  ##############
  ###
  # Configure bypass of Authenticated Origin Pulls for LAN
  # More relevant config at the end of ssl.conf
  ###
  geo $intranet {
    default 0;
    172.16.0.0/12 1;
    192.168.0.0/16 1;
  }
  ###
  # Get Real-IP since we're behind Cloudflare (w/ cloudflared)
  ###
  set_real_ip_from 172.16.0.0/12; # Make sure we get realip from cloudflared container
  real_ip_recursive on;
  real_ip_header CF-Connecting-IP; # Could also be X-Forwarded-For, but this is ALWAYS sent by Cloudflare

  # Rate Limiting #
  limit_conn_zone $binary_remote_addr zone=addr:10m;


  ###########
  # Servers #
  ###########
  ##############
  # xnaas.info #
  ##############
  # https://xnaas.info
  server {
    listen 443 ssl default_server;
    server_name xnaas.info;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    root /www/websites/xnaas.info;
    index index.html;

    location / {
      try_files $uri $uri/ =418;
    }

    location /tmp/ {
      alias /www/tmp/;
      try_files $uri $uri/ =404;
    }

    location /pgp {
      return 302 https://github.com/xnaas/pgp;
    }
  }


  # https://home.xnaas.info
  server {
    listen 443 ssl;
    server_name home.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app 192.168.1.150;
      set $upstream_port 5001;
      set $upstream_proto https;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://irc.xnaas.info
  server {
    listen 443 ssl;
    server_name irc.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app thelounge;
      set $upstream_port 9000;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://kb.xnaas.info
  server {
    listen 443 ssl;
    server_name kb.xnaas.info;
    include /config/nginx/ssl.conf;

    root /www/websites/kb.xnaas.info/website;
    index index.html;

    location / {
      try_files $uri $uri/ /404.html;
    }

    # rewrite because of move from wikijs
    location ^~ /en/public {
      rewrite ^/en/public(.*)$ $1 permanent;
    }
  }


  # https://live.xnaas.info
  server {
    listen 443 ssl;
    server_name live.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app owncast;
      set $upstream_port 8080;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://music.xnaas.info
  server {
    listen 443 ssl;
    server_name music.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app music;
      set $upstream_port 4533;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://notes.xnaas.info
  server {
    listen 443 ssl;
    server_name notes.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app joplin;
      set $upstream_port 22300;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://p.xnaas.info
  server {
    listen 443 ssl;
    server_name p.xnaas.info;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    root /www/websites/p.xnaas.info;

    location / {
      try_files $uri $uri/ =404;
      fancyindex on;
      fancyindex_exact_size off;
      fancyindex_localtime on;
      fancyindex_header "/nginx-dark/header.html";
      fancyindex_footer "/nginx-dark/footer.html";
      fancyindex_ignore "nginx-dark";
    }
  }


  # https://plex.xnaas.info
  server {
    listen 443 ssl;
    server_name plex.xnaas.info;
    include /config/nginx/ssl.conf;
    
    proxy_redirect off;
    proxy_buffering off;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app 192.168.1.101;
      set $upstream_port 32400;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
      
      # Are these even needed? â€” Testing required.
      proxy_set_header X-Plex-Client-Identifier $http_x_plex_client_identifier;
      proxy_set_header X-Plex-Device $http_x_plex_device;
      proxy_set_header X-Plex-Device-Name $http_x_plex_device_name;
      proxy_set_header X-Plex-Platform $http_x_plex_platform;
      proxy_set_header X-Plex-Platform-Version $http_x_plex_platform_version;
      proxy_set_header X-Plex-Product $http_x_plex_product;
      proxy_set_header X-Plex-Token $http_x_plex_token;
      proxy_set_header X-Plex-Version $http_x_plex_version;
      proxy_set_header X-Plex-Nocache $http_x_plex_nocache;
      proxy_set_header X-Plex-Provides $http_x_plex_provides;
      proxy_set_header X-Plex-Device-Vendor $http_x_plex_device_vendor;
      proxy_set_header X-Plex-Model $http_x_plex_model;
    }
  }


  # https://plexpy.xnaas.info
  server {
    listen 443 ssl;
    server_name plexpy.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app plexpy;
      set $upstream_port 8181;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    location ~ (/tautulli)?/api {
      include /config/nginx/proxy.conf;
      set $upstream_app plexpy;
      set $upstream_port 8181;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }

    location ~ (/tautulli)?/image {
      include /config/nginx/proxy.conf;
      set $upstream_app plexpy;
      set $upstream_port 8181;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://request.xnaas.info
  server {
    listen 443 ssl;
    server_name request.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app overseerr;
      set $upstream_port 5055;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://rss.xnaas.info
  server {
    listen 443 ssl;
    server_name rss.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app rss;
      set $upstream_port 80;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;

      proxy_buffering off;
      proxy_set_header X-Forwarded-Port $server_port;
      proxy_cookie_path / "/; HTTPOnly; Secure";
      proxy_set_header Authorization $http_authorization;
      proxy_pass_header Authorization;
    }
  }


  # https://tesla.xnaas.info
  server {
    listen 443 ssl;
    server_name tesla.xnaas.info;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app teslamate;
      set $upstream_port 4000;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://teslag.xnaas.info
  server {
    listen 443 ssl;
    server_name teslag.xnaas.info;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app teslamate-grafana;
      set $upstream_port 3000;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://www.*
  server {
    listen 443 ssl;
    server_name www.*;
    include /config/nginx/ssl.conf;
    return 302 https://dropwww.com/why;
  }


  # https://ãƒ„.xnaas.info
  server {
    listen 443 ssl;
    server_name xn--bdk.xnaas.info;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    root /www/websites/ãƒ„.xnaas.info;
    index index.html;

    location / {
      try_files $uri $uri/ =418;
    }
  }


  # https://ðŸ¤”.xnaas.info
  server {
    listen 443 ssl;
    server_name xn--wp9h.xnaas.info;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    root /www/websites/ðŸ¤”.xnaas.info;
    index index.html;

    location / {
      try_files $uri $uri/ =418;
    }
  }


  # https://ðŸ¤ª.xnaas.info
  server {
    listen 443 ssl;
    server_name xn--jq9h.xnaas.info;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    root /www/websites/ðŸ¤ª.xnaas.info;
    index index.html;

    location / {
      try_files $uri $uri/ =418;
    }
  }


  # https://ðŸ¤«.xnaas.info
  server {
    listen 443 ssl;
    server_name xn--kq9h.xnaas.info;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    root /www/websites/ðŸ¤«.xnaas.info;
    index index.html;

    location / {
      try_files $uri $uri/ =418;
      fancyindex on;
      fancyindex_exact_size off;
      fancyindex_localtime on;
      fancyindex_header "/nginx-dark/header.html";
      fancyindex_footer "/nginx-dark/footer.html";
      fancyindex_ignore "nginx-dark";
    }
  }


  ##################
  # actionsack.com #
  ##################
  # https://actionsack.com
  server {
    listen 443 ssl;
    server_name actionsack.com;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    root /www/websites/actionsack.com/website;
    index index.html;

    location / {
      try_files $uri $uri/ =404;
    }

    location /tmp/ {
      alias /www/websites/actionsack.com/tmp/;
      try_files $uri $uri/ =404;
      fancyindex on;
      fancyindex_exact_size off;
      fancyindex_localtime on;
      fancyindex_header "/nginx-dark/header.html";
      fancyindex_footer "/nginx-dark/footer.html";
      fancyindex_ignore "nginx-dark";
    }
  }


  # https://bib.actionsack.com
  server {
    listen 443 ssl;
    server_name bib.actionsack.com;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app bibliogram;
      set $upstream_port 10407;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://chat.actionsack.com
  server {
    listen 443 ssl;
    server_name chat.actionsack.com;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;
    
    root /www/websites/actionsack.com;
    index index.html;

    location / {
      try_files $uri $uri/ =418;
    }
  }


  # https://dl.actionsack.com
  server {
    listen 443 ssl;
    server_name dl.actionsack.com;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    root /www/download;

    location / {
      try_files $uri $uri/ =404;
      fancyindex on;
      fancyindex_exact_size off;
      fancyindex_localtime on;
      fancyindex_header "/nginx-dark/header.html";
      fancyindex_footer "/nginx-dark/footer.html";
      fancyindex_ignore "nginx-dark";
      location /Games/ {
        limit_conn addr 1;
        limit_rate_after 500M;
        limit_rate 10M;
      }
    }
  }


  # https://nitter.actionsack.com
  server {
    listen 443 ssl;
    server_name nitter.actionsack.com;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app nitter;
      set $upstream_port 8080;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://ott.actionsack.com
  server {
    listen 443 ssl;
    server_name ott.actionsack.com;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app ott;
      set $upstream_port 8080;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://p.actionsack.com
  server {
    listen 443 ssl;
    server_name p.actionsack.com;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    root /www/websites/p.actionsack.com;

    location / {
      try_files $uri $uri/ =404;
      fancyindex on;
      fancyindex_exact_size off;
      fancyindex_localtime on;
      fancyindex_header "/nginx-dark/header.html";
      fancyindex_footer "/nginx-dark/footer.html";
      fancyindex_ignore "nginx-dark" "nig";
    }
  }


  # https://i.actionsack.com
  server {
    listen 443 ssl;
    server_name i.actionsack.com;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app rimgu;
      set $upstream_port 8080;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://rss.actionsack.com
  server {
    listen 443 ssl;
    server_name rss.actionsack.com;
    include /config/nginx/ssl.conf;
    include /config/nginx/errors.conf;

    location / {
      auth_basic "Restricted";
      auth_basic_user_file /config/nginx/.asak;
      include /config/nginx/proxy.conf;
      set $upstream_app rss-bridge;
      set $upstream_port 80;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://send.actionsack.com
  server {
    listen 443 ssl;
    server_name send.actionsack.com;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app send;
      set $upstream_port 1234;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://srsbznz.actionsack.com
  server {
    listen 443 ssl;
    server_name srsbznz.actionsack.com;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app meme-wiki;
      set $upstream_port 80;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://webchat.actionsack.com
  server {
    listen 443 ssl;
    server_name webchat.actionsack.com;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app thelounge-public;
      set $upstream_port 9000;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }


  # https://ytdl.actionsack.com
  server {
    listen 443 ssl;
    server_name ytdl.actionsack.com;
    include /config/nginx/ssl.conf;

    location / {
      include /config/nginx/proxy.conf;
      set $upstream_app youtubedl;
      set $upstream_port 8080;
      set $upstream_proto http;
      proxy_pass $upstream_proto://$upstream_app:$upstream_port;
    }
  }
}
